
<html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
  <!--Load tha js and jquery API-->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
  <script type="text/javascript" charset="utf-8"></script>
  <!--Load the AJAX API-->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script type="text/javascript" src="./script/Overview.js"></script>
  <script type="text/javascript" src="./script/Revenue.js"></script>
  <script type="text/javascript" src="./script/Retention.js"></script>
  <script type="text/javascript" src="./script/Realtime.js"></script>

  <link rel="stylesheet" type="text/css" href="./css/style.css">
</head>

<body>
  <div id="wrap">
    <div id="header" class="subheader">
      <div id="topmenu">
        <div id="logo">
          <a href="/">
            <img src="logo.png"/>
          </a>
        </div>
        <nav id="menu">
          <ul id="menu-nav" class="mainMenu">
            <li class="interval">
              <a class="underbar" href="#">기본지표 </a>
              <ul class="subMenu" id="idSub">
                <li class="sub"><a href="#" onclick="callDAU()" style="padding-top:12px;">AU </a></li>
                <li class="sub"><a href="#" onclick="callDPA()" style="padding-top:12px;">매출액 </a></li>
                <li class="sub"><a href="#" style="padding-top:12px;">설치수 </a></li>
                <li class="sub"><a href="#" style="padding-top:12px;">평균 게임플레이 시간 </a></li>
              </ul>
            </li>
            <li class="interval">
              <a class="underbar" href="#">인앱매출 </a>
              <ul class="subMenu" id="idSub" style="margin-left:-227px;">
                <li class="sub"><a href="#" style="padding-top:12px;">AU3 </a></li>
                <li class="sub"><a href="#" style="padding-top:12px;">AU4 </a></li>
              </ul>
            </li>
            <li class="interval">
              <a class="underbar" href="#">리텐션 </a>
              <ul class="subMenu" id="idSub" style="margin-left:-454px;">
                <li class="sub"><a href="#" style="padding-top:12px;">AU3 </a></li>
                <li class="sub"><a href="#" style="padding-top:12px;">AU4 </a></li>
              </ul>
            </li>
            <li class="interval">
              <a class="underbar" id="ML" href="#">머신러닝 </a>
              <ul class="subMenu" id="idSub" style="margin-left:-681px">
                <li class="sub"><a href="#" style="padding-top:12px;">AU3 </a></li>
                <li class="sub"><a href="#" style="padding-top:12px;">AU4 </a></li>
              </ul>
            </li>
          </ul>
        </nav>
        <div class="navi_bg" style="display: none;"></div>
      </div>
    </div>

    <div id="content">
      <div id="graph_loading" style="text-align:center; margin-top:100px;">
        Loading...<br>
        <div id="loading">●</div>
      </div>
      <div class="graph" id="Graph1">
      </div>
      <div class="graph" id="Graph2">
      </div>
      <div class="graph" id="Graph3">
      </div>

      <div style="margin-left:100px;">
        <input id='memberID'/>
        <button id="registerBtn">Submit</button>
        <div id="submit_loading" style="text-align:center;"></div>
        <div id="probab" style="text-align:center;"></div>
      </div>
    </div>

  </div>
</body>

<!-- Submenu -->
<script>
var closeTimer = null;
var counterTimer = 300;
var noClose = 0;
var colNum = 0;
  $(".subMenu").hide();
  $(".mainMenu>li").hover(function() {
    if(colNum == 0) {
      $(".navi_bg").slideDown(200);
      colNum++;
    }
    $(".subMenu").hide();
    $(this).find(".subMenu").stop().slideDown(400);
    mcancelclosetime();
  },function() {
    mclosetime();
  });
// Turn On Close Timer
function mclosetime() {
    closeTimer = window.setTimeout(mclose, counterTimer);
}
// Cancel Close Timer
function mcancelclosetime() {
    if(closeTimer) {
        window.clearTimeout(closeTimer);
        closeTimer = null;
    }
}
// Close Showed Layer
function mclose() {
  $(".mainMenu>li").find(".subMenu").slideUp(250);
  $(".navi_bg").slideUp(200);
  colNum = 0;
}

</script>
<!-- Azure ML script -->
<script>
// ML columns
var Nickname, Gender, Login, CashDate, JoinDate, Cash, Level, Country, Coupon, Device, Accumulate, RareItem;
var EmailConfirm, Recommender, Bestitem1, Bestitem2, Bestitem3, GiftTo, GiftFrom;
$("#registerBtn").click(function() {
  $("#probab").empty();
  $("#submit_loading").append('<br>' +
    'Loading...<br>' +
    '<div id="loading">●</div>'
  );
  var host = "/";
  var memberID = document.getElementById("memberID").value;
  var promise_mem = new Promise(function (resolve, reject) {
    $.ajax({
      type: "GET",
      url: host + "odata/Members?$filter=MemberID%20eq%20'" + memberID + "'",
      dataType: "text",
      error: function() {
        reject(Error("Fail"));
        alert('Host not found! Please check the host name.');
      },
      success: function(data) {
        var pars = JSON.parse(data);
        var value = pars['value'];
        if(value.length == "0") {
          alert('Do not exist this Member!');
          $("#submit_loading").empty();
          reject(Error("Fail"));
        } else {
          Nickname = value[0]['Name1'];
          EmailConfirm = value[0]['EmailConfirmedYN'];
          Recommender = value[0]['Recommender']?'Y':'N';
          Gender = value[0]['sCol1'];
          Device = value[0]['sCol2'];
          Country = value[0]['sCol3'];
          Login = value[0]['sCol4'];
          RareItem = parseInt(value[0]['sCol5']);
          Bestitem1 = value[0]['sCol6'];
          Bestitem2 = value[0]['sCol7'];
          Bestitem3 = value[0]['sCol8'];
          Coupon = value[0]['sCol9'];
          JoinDate = parseInt(value[0]['CreatedAt'].substring(0,4)
           + value[0]['CreatedAt'].substring(5,7)
           + value[0]['CreatedAt'].substring(8,10));
          resolve("Complete");
        }
      }
    });
  });
  var promise_level = new Promise(function (resolve, reject) {
    $.ajax({
      type: "GET",
      url: host + "odata/MemberGameInfoes?$filter=MemberID%20eq%20'" + memberID + "'",
      dataType: "text",
      error: function() {
        reject(Error("Fail"));
        alert('Host not found! Please check the host name.');
      },
      success: function(data) {
        var pars = JSON.parse(data);
        var value = pars['value'];

        Level = value[0]['Level'];
        resolve("Complete");
      }
    });
  });
  var promise_cash = new Promise(function (resolve, reject) {
    $.ajax({
      type: "GET",
      url: host + "odata/MemberItemPurchases?$filter=MemberID%20eq%20'" + memberID + "'",
      dataType: "text",
      error: function() {
        reject(Error("Fail"));
        alert('Host not found! Please check the host name.');
      },
      success: function(data) {
        var pars = JSON.parse(data);
        var value = pars['value'];
        var size = value.length - 1;
        Accumulate = 0;

        Cash = parseInt(value[size]['PurchasePrice']);
        CashDate = parseInt(value[size]['PurchaseDT'].substring(0,4)
         + value[size]['PurchaseDT'].substring(5,7)
         + value[size]['PurchaseDT'].substring(8,10));

        for(var i = 0; i <= size; i++) {
          Accumulate += parseInt(value[i]['PurchasePrice']);
        }
        resolve("Complete");
      }
    });
  });
  var promise_giftTo = new Promise(function (resolve, reject) {
    $.ajax({
      type: "GET",
      url: host + "odata/GiftDepositories?$filter=FromMemberID%20eq%20'" + memberID + "'",
      dataType: "text",
      error: function() {
        reject(Error("Fail"));
        alert('Host not found! Please check the host name.');
      },
      success: function(data) {
        var pars = JSON.parse(data);
        var value = pars['value'];
        GiftTo = parseInt(value.length);
        resolve("Complete");
      }
    });
  });
  var promise_giftFrom = new Promise(function (resolve, reject) {
    $.ajax({
      type: "GET",
      url: host + "odata/GiftDepositories?$filter=ToMemberID%20eq%20'" + memberID + "'",
      dataType: "text",
      error: function() {
        reject(Error("Fail"));
        alert('Host not found! Please check the host name.');
      },
      success: function(data) {
        var pars = JSON.parse(data);
        var value = pars['value'];
        GiftFrom = parseInt(value.length);
        resolve("Complete");
      }
    });
  });

  Promise.all([promise_giftFrom, promise_giftTo, promise_cash, promise_mem
    , promise_level]).then(function() {
      var requestVal = {
      "Inputs": {
        "input1": {
          "ColumnNames": [
            "Nickname",
            "Gender",
            "Login",
            "CashDate",
            "JoinDate",
            "Cash",
            "Level",
            "Country",
            "Coupon",
            "Device",
            "Accumulate",
            "RareItem",
            "EmailConfirm",
            "Recommender",
            "Bestitem1",
            "Bestitem2",
            "Bestitem3",
            "GiftTo",
            "GiftFrom",
            "Leave"
          ],
          "Values": [
            [
              Nickname,
              Gender,
              Login,
              CashDate,
              JoinDate,
              Cash,
              Level,
              Country,
              Coupon,
              Device,
              Accumulate,
              RareItem,
              EmailConfirm,
              Recommender,
              Bestitem1,
              Bestitem2,
              Bestitem3,
              GiftTo,
              GiftFrom,
              "1"
            ]
          ]
        }
      },
      "GlobalParameters": {
        "New column names": "Leave"
      }
    }

    var JsonRequest = JSON.stringify(requestVal);
      $.ajax({
        url: host + "api/values",
        type: "POST",
        contentType: 'application/x-www-form-urlencoded; charset=utf-8',
        data: '=' + JsonRequest,
        error: function() {
          alert('Fail...');
          $("#submit_loading").empty();
        }
      }).done(function (data) {
        console.log(data);
        var pars = JSON.parse(data);
        var value = pars['Results']['output1']['value']['Values'];
        var arr_size = parseFloat(value[0].length) - 1;
        var result = parseFloat(value[0][arr_size]);

        result = parseInt(result * 100.0);
        $("#submit_loading").empty();
        $("#probab").empty();
        $("#probab").append("이탈 확률 : " + result + " %");
      });
  });
}); // click()
</script>

<script>
//ready
$(function() {
  callAU();
});
</script>

</html>
